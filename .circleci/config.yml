version: 2.1

jobs:
  build:
    docker:
      - image: alexfalkowski/go:1.21-3.2
      - image: postgres:latest
        environment:
          POSTGRES_DB: test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
      - image: redis:latest
      - image: nsqio/nsq:latest
        command: /nsqlookupd
      - image: nsqio/nsq:latest
        command: /nsqd --lookupd-tcp-address=localhost:4160
      - image: alexfalkowski/auth:latest
        command: server
        environment:
          CONFIG_FILE: yaml:CONFIG
          CONFIG: ZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KY2FjaGU6CiAgcmlzdHJldHRvOgogICAgbnVtX2NvdW50ZXJzOiAxMDAwMDAwMAogICAgbWF4X2Nvc3Q6IDEwMDAwMDAwMAogICAgYnVmZmVyX2l0ZW1zOiA2NApjYXNiaW46CiAgbW9kZWw6IHwKICAgIFtyZXF1ZXN0X2RlZmluaXRpb25dCiAgICByID0gc3ViLCBvYmosIGFjdAoKICAgIFtwb2xpY3lfZGVmaW5pdGlvbl0KICAgIHAgPSBzdWIsIG9iaiwgYWN0CgogICAgW3BvbGljeV9lZmZlY3RdCiAgICBlID0gc29tZSh3aGVyZSAocC5lZnQgPT0gYWxsb3cpKQoKICAgIFttYXRjaGVyc10KICAgIG0gPSByLnN1YiA9PSBwLnN1YiAmJiByLm9iaiA9PSBwLm9iaiAmJiByLmFjdCA9PSBwLmFjdAogIHBvbGljeTogfAogICAgcCwga29uZmlnLCBzdGFuZG9ydCwgZ2V0LWxvY2F0aW9uCmhlYWx0aDoKICBkdXJhdGlvbjogMXMKICB0aW1lb3V0OiAxcwprZXk6CiAgZWQyNTUxOToKICAgIHB1YmxpYzogSVJ2cUFvUTRZV3FxVEwySVVSdWNQYkpIVlNMdzAvSVdMQ3p2cmlIbGhmYz0KICAgIHByaXZhdGU6IEV4TFBGSWlPTEI2ZmxsQzBMeXNlVXlpd0V5dTQwM2ordmsyR0QxdjJMS1VoRytvQ2hEaGhhcXBNdlloUkc1dzlza2RWSXZEVDhoWXNMTyt1SWVXRjl3PT0KICByc2E6CiAgICBwdWJsaWM6IE1JSUNDZ0tDQWdFQXJyN3dYRHQ2NHhHbXBPVXRlL0NpV28ybGsxM3NheElONStwMmJsYXR3emZVbVdsRVMwMVdYaDk1cmI3ZXpyKzlhNlJWRW9KOVY2dUVPRDhxTGVvSEJZSXpMb0I3d3J0TkFsT1hFWTRuaXF6Rm9WVXNpdTZSc3RmNDUrdXVUMUpnMjd0bjVwUlBFNUxRR2dMZlJ3K3JObUI5cHJVL3IrR29qazlRRzI0Y05mLzBNMHZuT1o0dDJML2ZTUW83WFhkM1U3QXNHNHIxYWVuR3lvUHdlVmdNWXkvOC84SzlaWUNMd3JjSUtZcU56T1grSkZBN2FHaDlOc3FRWU1TSUpoYWZLbFBIbHBGaWNVa3JjUGtmUFRiWU1ZYXU4MmZMYWh0Tjd4MC8yK21jdy85RzczUzRkNVJoNkNGZ3FVZ096aThGVXZmYXEvZTQyQU1CZkdQdXA0ODFxQ2UyS3hzRS83b0I1ZURSQU91c1pDbzgzeDl1VjVCakxva3FUWGw5V2NtYzdXOTBKM3VuTEVPK21yR1VaaENzd3p1RVJnZmc3YTJXMjV4NFBBZjI5aGU2eGpFWUNoaVYrRjdXUkhVUThGV2pWQUJuSWI2VVNNS1crYUI3a2xCejVmQ2VhRHRiWFRFR3YwMVhoOXhiNm0rNC9SbW1iZlZicjl0aHc5UWlWWTVtSkEwRnFGMnI0VDZ6TVJIa3ZtVCtUdDVBTUhuRmR6SldSWFRBVFZDSmZ4Q3FJTUN4OTRpZnE3YzhTTnF0OGo3MnhqanNMbGFDNVBFRUNKL2RrSnJ1aFJTWnM4YUlTZXZCSWR2SmVWaC9NTWRhaml5UW92VmpIVzhXUkh3Z0ZyZjJSbDB0MGczbHNHcUFHUTJxenk2c05jMjcrdWw5YjJZbzdKWUVyVzV6bjJrQ0F3RUFBUT09CiAgICBwcml2YXRlOiBNSUlKS0FJQkFBS0NBZ0VBcnI3d1hEdDY0eEdtcE9VdGUvQ2lXbzJsazEzc2F4SU41K3AyYmxhdHd6ZlVtV2xFUzAxV1hoOTVyYjdlenIrOWE2UlZFb0o5VjZ1RU9EOHFMZW9IQllJekxvQjd3cnROQWxPWEVZNG5pcXpGb1ZVc2l1NlJzdGY0NSt1dVQxSmcyN3RuNXBSUEU1TFFHZ0xmUncrck5tQjlwclUvcitHb2prOVFHMjRjTmYvME0wdm5PWjR0MkwvZlNRbzdYWGQzVTdBc0c0cjFhZW5HeW9Qd2VWZ01ZeS84LzhLOVpZQ0x3cmNJS1lxTnpPWCtKRkE3YUdoOU5zcVFZTVNJSmhhZktsUEhscEZpY1VrcmNQa2ZQVGJZTVlhdTgyZkxhaHRON3gwLzIrbWN3LzlHNzNTNGQ1Umg2Q0ZncVVnT3ppOEZVdmZhcS9lNDJBTUJmR1B1cDQ4MXFDZTJLeHNFLzdvQjVlRFJBT3VzWkNvODN4OXVWNUJqTG9rcVRYbDlXY21jN1c5MEozdW5MRU8rbXJHVVpoQ3N3enVFUmdmZzdhMlcyNXg0UEFmMjloZTZ4akVZQ2hpVitGN1dSSFVROEZXalZBQm5JYjZVU01LVythQjdrbEJ6NWZDZWFEdGJYVEVHdjAxWGg5eGI2bSs0L1JtbWJmVmJyOXRodzlRaVZZNW1KQTBGcUYycjRUNnpNUkhrdm1UK1R0NUFNSG5GZHpKV1JYVEFUVkNKZnhDcUlNQ3g5NGlmcTdjOFNOcXQ4ajcyeGpqc0xsYUM1UEVFQ0ovZGtKcnVoUlNaczhhSVNldkJJZHZKZVZoL01NZGFqaXlRb3ZWakhXOFdSSHdnRnJmMlJsMHQwZzNsc0dxQUdRMnF6eTZzTmMyNyt1bDliMllvN0pZRXJXNXpuMmtDQXdFQUFRS0NBZ0J6VDAvd3JOZEVhMnRadUZreFJmTDhhaWZ1ZkxYN1dXaVB0dW43bVhzRUxSMC9OblY0YzBvZ3hnaFhISEtPWDN3eFFibFpnMzRPa2dHbjFCYVRRYkRzYzZRdWRWNDFlNzh2WDlWNklpSDVvbFN2UnpNallwWUdPL25sb0dIZnVlNXNVTmdaRVppMHc5WktzOForYjlwOUFXTW8xTVYzM0NLTDljNVlxMm8yUC9YMnU0bVRQY3ZuRVlYWC9zWjV3TkdmQ2N1eFNScjBqdTA4eVordmt1aHBzMHJ4d3FHVUR5VXFrZmp5NEpqOXNtN25xNEhvUGJzU29zeHU3b0VoRVNCcW4rbytjeVZRdUFYUWdMT2FnMHhhTWhQVVRwT3VLdUpjZlNLY2pTV0RPRHFvM0k2MWFkYkpoT3p5QjdpdFdkM2JoKzVtT0F0amoyZzFtd1BxMGRlSFRPZS84NXRLRW1xVkZOTkNGSkhjM2tDa0loMFFQM0UwZVgweTFKbFVJVWh1ZWh5QkFPMG0zTloyQ2puczBWaXJLdmxGc2pQYU1RR2wvOUdJdmNxNzdKL2VINU9WT2lTS0N4ZzRyc2JuUHdrTUhkREJtNEdlOFovNklWcWEzNGJrTFA2UGZFN2ZBdWlabHp4b0kvUVQxUTAxeEQ0SGZDSmlSZDN5dW53Yit2elJQS2QxTTFjUkpNWVJtaHFUUmxNVm1iRXV2Y3YvOFhJcnNRdUx3UFIrdWJlTWt1K3ovbVlzT09pazROdjVKaGZpcndqelkvUmhoZ2UzZzlDdW5KUGtWMXQxV1U1NjREejhpT2ZCNU8yVmpydWJTWitRb2RGZWR2cUVjclJpc3NCSENKeEowRGcvRHFNbUFIeEtDWUswZU11YTc4NXVjaEhHTEZOeTVQWVFBUUtDQVFFQXcrYUpxd2Rpc2pGaGJ5QnVNNEwzTlNGUVBGWGEyVUlYNG4zQVNMaHhYRU5ZNndDcEpKTnBscWlxR0VlaWZKTDJIQUtQR3FxbHJ6S1RzMFpBWmM5T1RrQ0hOM1p1cHlYTDFUUUFLaXhGaXFKUEduSnowaDBmcDN1cFk5Vkljd251UFJ1M0tDUTFVMm81WUxWOGdobi9aSmdnYTc5cGVZam5yUlhMZlJPMXBqUmdGN05OLzk0eHJmelNiclBVdTBWVCtYUXRUNGlySEdTZ1RaeVFzUWlSblBQUHhFdjRLTFFiYk0yQm1vcm1Gb0ZONjNUUW9xZVdtWjZyTzU5ekFBK3VyZCtLdEhRSDZyMHVUSGV4MUNxN25SZVR3RTdSaUw3MXhNcldJV1hPbUpOem5sWXE5aW12ZzNWeTVhOGk5amU4V3h6Nm4vUGdLMERRb3RmUldjUjBhUUtDQVFFQTVGcjVOS0laRW5FNTYyZ3h4OWxpUVF3bks3dnpFYno4OTdjeGNBTnpTVG1kbUVtMHlzNE5YcmJDU3AzUExHZGtnM3lNZGx4TGNoajlPMnZydjhlaEJNNGliQkkzbzlESDl5VXl3N29kNVAxSWI2RVM5VkJmWHA3V1NPa2hyb1VqOGZWSzhkQ1lxOXAyanRldUNKUEdwSmdtUUdvT1R5Mm9WL2czT2tKVjhOVVRIbDArOXpiK050NTNpOVRJamh5QVRqdU1IWmE2eXJkNDRQWUlXQXBjQVhBcXh4N0VaQllyWGRzVndtOUJ0T0RHdUdhSE1acEdzTmlRT0dDSG9UbWptb0JiYUJTV2wxUEthMHA0UmRWb2FZOG0zREV1c3BabFpKcGc2TjFkYlRBUjFPRVdDUWVaOUgxaEg2dVR2LytEdlM4b1NLRWtTNG9kc0k3YmxNUnpBUUtDQVFBTUNBZWllbVNrWHdZRjVpNytlT2VuMnJEcjA3WUtLOVg5c2cxeUtlbkVhZHAzTEdZMitkcTlSd1NUVXlyMmphd1IwbEpwcDl0ZkpETVFDcHQvNVRpQTg5T2FJMnJ1VnhMcXVEUGVZek91TFFQQXN4REw4Yi8wOEZKWjhFcHZ6a2RVZDNSTFFkWUlsbmlKcVB2Sm5jRWlzM2tpUlBJOFpaMGM4ejY1SXRIQU1HMUtaMWUrQkM1MjZoVWVlV3J5U1hLNzJsZkNEN202bDYrRXRMM3FNWVdINXkxMmQ5ZjQzLzdqTXNmbjd1bnNyZXBVTUt0em9lbE03QUxHT2FlOWREa2RNcUo1TExzanZwU3VXNWVQV1VTR2hHRXRxV21UQlc5Z3M3aHMrcXl5a0RQRW9MUW94Q3lrWFQwK1FBQmNzTldmbnVzQmtkL05xRUJvRCtzcW9UY3BBb0lCQURrbWs0d2FyWSt5Q3I3aDJ1T2JnajJwWHZ4UkU2cHkxQlRqSWxwWVlyZ0cxV3hSdGcrenRpRG9PSVFZTHN0OExPbkRlQnYvU1ZxSzZvVytvc2ZpbkdmcGR5LzQ5emZtZnNWWjUvU1lWZmNEZE9lTE5vVnkwZ3VLVVRMNk5kWEp1STlMeHEveWR1TTd6OFE4TW5Bdkc5NEJ2a0VNeWZ3Qy8walU5RzErUUtmL2k4TmpydWlNT045ZW1pakMzbGJDeDFITkVXb3VXUjEzQWFlN3E2YnRJTTJ6VnVGeXo5QUV4R0crL1JrbVl4bHowQWhDa0w5WFR5M2ZaV2pXcjlzbjQ4dzlKNk5LMDgyWHlPZEZRZ2lvT25PQXdrY0ZnQnh1QzM0OExOamEzaEQvb05iWVpuMW9DNTNtNnpIVDdTeDJOSEJhcHdoV1hCRVR4ZzUwRW55UEZnRUNnZ0VCQUtpY1l3QVU5alZTbzZCWTZ3S0k0b2VsVGo0VEpZdlBEK095U1U4THkzNG02T3lJc00vWW1jUjVOY2VYYWIyYkFZTjlCdlcrY1l4SW9kZXR2bHNTb2FyQ3ppUFdvWGJ0QzhpL3FxZ2J1eThyNjVvZ3pPNXNkN2Y2WWRveTNMNm5lMURjam1wd084VXVaU1E0UGswWHBjR3RFZExoZ0thcmFzUkVZbFZxOFo0eFNtOTdDODNMR0p0aHl1RDFRQXB1Ly8wT3AxV0ZZampRcHB5WG45blUxMlFlNWVsMGRjZk9ES1MwOW5UZ1hQOE9Qa0d5WWw2TCt1UDh3ZXV4MkZRSmJsY2F2b1hKUG1SSmJqOU1VcU5Fa2NpUjJHdC9aQnc3ME9EeWRvR0hvUFZrRVBQd1JyVjd2TEpSZ0dyMHNYaUo5NVFIRU1udTh6dnJKb212d0FLL0NxOD0Kc2VydmVyOgogIHYxOgogICAgaXNzdWVyOiBodHRwczovL2F1dGguZmFsa293c2tpLmlvCiAgICBhZG1pbnM6CiAgICAgIC0gaWQ6IHN1LTEyMzQKICAgICAgICBoYXNoOiAkMmEkMTAkZ0ROZ0V1ZEJlLndKZDdjWnRCcTl0dUFGcEh2WHV6ZXJ2eWxtNTkzVlk3UHQ0TzlJLnpKRW0KICAgIHNlcnZpY2VzOgogICAgICAtIGlkOiBlMTYwMmUxODVjYmEyYTkwZDhiYmNmYzNmM2M1NTMwYwogICAgICAgIG5hbWU6IGtvbmZpZwogICAgICAgIGhhc2g6ICQyYSQxMCRiaW1VSTVNL3BrUllnSUMzVUh6Z3kuY1pqRmV0TnZndDN2Ry5TUFZRUnNxVThPRmI4VjlVRwogICAgICAgIGR1cmF0aW9uOiAyNGgKICAgICAgLSBpZDogN2U4YzI0Mzc5OTMwZDEwN2IyZDI4MWFhMjMyNDcwOTIKICAgICAgICBuYW1lOiBzdGFuZG9ydAogICAgICAgIGhhc2g6ICQyYSQxMCRIc0hxS2ZpRXc4eFNhdmJOLkVBdFYuQ3FzLjE3bS5oeTd2VmpLa3lGVTdETnJ0ZURhRExLaQogICAgICAgIGR1cmF0aW9uOiAyNGgKdGVsZW1ldHJ5OgogIGxvZ2dlcjoKICAgIGxldmVsOiBpbmZvCiAgdHJhY2VyOgogICAgaG9zdDogbG9jYWxob3N0OjQzMTgKICAgIHNlY3VyZTogZmFsc2UKdHJhbnNwb3J0OgogIGh0dHA6CiAgICBwb3J0OiA1MDAwCiAgICB1c2VyX2FnZW50OiAiQXV0aC1zZXJ2ZXIvMS4wIGh0dHAvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDJzCiAgICAgIGF0dGVtcHRzOiAzCiAgZ3JwYzoKICAgIGVuYWJsZWQ6IHRydWUKICAgIHBvcnQ6IDUwMDEKICAgIHVzZXJfYWdlbnQ6ICJBdXRoLXNlcnZlci8xLjAgZ3JwYy8xLjAiCiAgICByZXRyeToKICAgICAgdGltZW91dDogMnMKICAgICAgYXR0ZW1wdHM6IDMK
      - image: alexfalkowski/status:latest
        command: server
        environment:
          CONFIG_FILE: yaml:CONFIG
          CONFIG: ZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KaGVhbHRoOgogIGR1cmF0aW9uOiAxcwogIHRpbWVvdXQ6IDFzCnRlbGVtZXRyeToKICBsb2dnZXI6CiAgICBsZXZlbDogaW5mbwogIHRyYWNlcjoKICAgIGhvc3Q6IGxvY2FsaG9zdDo0MzE4CiAgICBzZWN1cmU6IGZhbHNlCnRyYW5zcG9ydDoKICBodHRwOgogICAgcG9ydDogNjAwMAogICAgdXNlcl9hZ2VudDogIlN0YXR1cy1zZXJ2ZXIvMS4wIGh0dHAvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDJzCiAgICAgIGF0dGVtcHRzOiAzCiAgZ3JwYzoKICAgIGVuYWJsZWQ6IHRydWUKICAgIHBvcnQ6IDYwMDEKICAgIHVzZXJfYWdlbnQ6ICJTdGF0dXMtc2VydmVyLzEuMCBncnBjLzEuMCIKICAgIHJldHJ5OgogICAgICB0aW1lb3V0OiAycwogICAgICBhdHRlbXB0czogMwo=
    working_directory: ~/go-service
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run:
          dockerize -wait tcp://localhost:5432 -wait tcp://localhost:6379 -wait tcp://localhost:4161 -wait tcp://localhost:4150 -wait tcp://localhost:5000 -wait tcp://localhost:6000 -timeout 1m
      - run: make dep
      - run: make lint
      - run: make sec
      - run: make setup-nsq
      - run: make specs
      - run: make goveralls
      - store_artifacts:
          path: test/reports
    resource_class: large
  release:
    docker:
      - image: alexfalkowski/release:3.1
    working_directory: ~/go-service
    steps:
      - checkout
      - run: release
    resource_class: large

workflows:
  go-service:
    jobs:
      - build
      - release:
          context: gh
          requires:
            - build
          filters:
            branches:
              only: master
